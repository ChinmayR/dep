#!/bin/bash

# Get the current directory (traversing all symlinks)
pushd . > /dev/null
SCRIPT_PATH="${BASH_SOURCE[0]}";
while([ -h "${SCRIPT_PATH}" ]); do
  cd "`dirname "${SCRIPT_PATH}"`"
  SCRIPT_PATH="$(readlink "`basename "${SCRIPT_PATH}"`")";
done
cd "`dirname "${SCRIPT_PATH}"`" > /dev/null
BASEDIR="`pwd`";
popd  > /dev/null

# Make sure PATH is prefixed with our BASEDIR
if [[ "$PATH" != "$BASEDIR:"* ]]; then
  export PATH="$BASEDIR:$PATH"
fi

_GO_ARCH="$(echo $(uname -s)-$(uname -m) | tr '[A-Z]' '[a-z]')"
# Build the binary in case it does not exist, and then run it.
FILENAME="`basename $0`"
TARGET=".go/bin/${_GO_ARCH}/$FILENAME"
make --silent -C "$BASEDIR" "$TARGET" 1>&2 || { echo "Fetching $FILENAME failed!" 1>&2; exit 1; }
exec "$BASEDIR/$TARGET" $@
