Procedure for panicking
=======================

## Description

We panic when wonka clients cannot communicate with wonkamaster
or otherwise cannot get claims or certificates.

We want all clients to fail open. That is, they will allow
requests to proceed without requiring claims issued by
the wonkamaster when it is not available.

## How it works

We publish a DNS TXT entry that all clients check. If a valid
DNS entry is published, clients will check that it is correctly
signed by the wonkamaster's private key and not expired. This is handled in `wonka_disabled.go`, in `IsGloballyDisabled`.

If so, clients cease requiring authentication and requesting
claims for inbound requests.

## Procedure

### Generate and upload DNS TXT record

1. Generate the DNS TXT record key and value.
```
$ wonkacli --privkey /path/to/wm/private/key disable -e 1h
```
This command will generate a record which will disable wonkamaster for 1 hour, or `20h` for 20 hours. You will get something like this:
```
[13:41:52.27]  INFO pubkey_hash=KMKPB8EQ5JVJDD778OD3R59Q7FP17QKED6H1QD025B0KKMI3PGDG
eyJjdGltZSI6MTUwODM2NjIwOCwiZXRpbWUiOjE1MDgzNjk4MDgsImlzX2Rpc2FibGVkIjp0cnVlLCJzaWduYXR1cmUiOiJncnpTMXhobDZkbVdScXRkUDBKU25STURiWjdTMEpqM21wbnFzdWRDcVVpcHVscGkzMkZITEc4aFluUE95TzlGNHJjLzZDa2N2SFFGU3ViRHlIZzhGZz09In0=
```
The default place for the wonkamaster private key is in Langley, specified in `config/secrets.yaml`.

2. Log into `portal.ultradns.com`, click the tab `Domain Services` and search for `uberinternal.com` and enter it.
(Click the domain, not the `view` button.)

3. Click `TXT` at the left panel and add a TXT record of the `pubkey_hash`. The
   value is the base64-encoded string (the last line of the above output).
   Please don't change the TTL value in the record, it should be kept low so
   clients notice updates quickly. Panic expiration time is set in the record
   content already.

4. When you are done, you will have a TXT record of `KMKPB8EQ5JVJDD778OD3R59Q7FP17QKED6H1QD025B0KKMI3PGDG.uberinternal.com` with contents of:
```
eyJjdGltZSI6MTUwODM2NjIwOCwiZXRpbWUiOjE1MDgzNjk4MDgsImlzX2Rpc2FibGVkIjp0cnVlLCJzaWduYXR1cmUiOiJncnpTMXhobDZkbVdScXRkUDBKU25STURiWjdTMEpqM21wbnFzdWRDcVVpcHVscGkzMkZITEc4aFluUE95TzlGNHJjLzZDa2N2SFFGU3ViRHlIZzhGZz09In0=
```
Note: the TXT record showed above is generated by wonkamaster-staging's private key for remote testing.

5. Once everything is returned to normal, set TXT record back to place
   holder value "stand-in record to keep the ttl low", so wonka client doesn't
   have to work to interpret an expired record.

### Test with Local Services

We can also mock the panic behavior in dev environments.

#### AuthenticateIn

1. First, make sure you're running wonkamaster locally and have access to its private key (see `wonkamaster/DEVELOPING.md`).
2. Generate a DNS TXT record using the local wonkamaster private key.
```
$ wonkacli --privkey wonkamaster/private.pem disable -e 1h
[15:59:49.57]  INFO  pubkey_hash=4IFJPLFC4C20NHPENQKCPAEOB4CAOD74MNFJVBAOL5H31POF615G
eyJjdGltZSI6MTUxMDI3MTk4OSwiZXRpbWUiOjE1MTAyNzU1ODksImlzX2Rpc2FibGVkIjp0cnVlLCJzaWduYXR1cmUiOiIzejBvdXorb0Nvek51dUNpN3p3aGNuL1VEYkhBNXVXVHJvYS9mR1IzVWhvNTZPSGorbHhmWlRIc1UvRGJrQlAwdlY2UUlMNFN5d0ZoNDRweEZQVXlJZz09In0=
```
3. Save the record to a file in your test project (say, `maffeo`) repo. This file will mimic a DNS record, so make sure the filename is `<pubkey_hash>.uberinternal.com` and its content is the last line of base64-encoded string from step 1.
```
$ echo 'eyJjdGltZSI6MTUxMDI3MjE5OCwiZXRpbWUiOjE1MTAyNzU3OTgsImlzX2Rpc2FibGVkIjp0cnVlLCJzaWduYXR1cmUiOiIwRkhoc3ovR2pRejJDUG5UT0lrVFR1eWVrUWg1ak5PbS83eGl4YS8rN0grODcwdjREbjk4akZkeHdVYXhjRWVVaUlrM1h4dHZVYkt6Zk91ZWNmcXZyQT09In0=' > 4IFJPLFC4C20NHPENQKCPAEOB4CAOD74MNFJVBAOL5H31POF615G.uberinternal.com
```
Copy the file to the home directory of your local service, say `maffeo.git`.

4. Modify config/developmet.yaml. In this example, change the values of `wonka_master_public_keys` and `wonka_master_url` to `034972c99f87365605238e328d4e4f3d033dead4b6c4dca3eded20a4accf404684` and `http://127.0.0.1:16746` respectively. The original values of the two fields are intended for wonkamaster-staging. We will cover it later.

5. Start up your local service. Set the current directory (`"."`), as the `WONKA_PANIC_DIR` environment variable:
```
$ WONKA_PANIC_DIR=. make run
```
If successful, you should see output like:
```
2017-11-09T16:11:44.143-0800    WARN    wonka-go.git/wonka_disabled.go:101      disabling wonka; may willie have mercy on our souls     {"galileo": {"entity": "maffeo", "wonka": {"entity": "maffeo"}}}
2017-11-09T16:11:44.143-0800    DEBUG   wonka-go.git/wonka_disabled.go:104      wonka global disabled status refreshed  {"galileo": {"entity": "maffeo", "wonka": {"entity": "maffeo"}}}
```
If you already upload the DNS TXT record to DNS server, you may just need run
```
$ make run
```

6. Test `maffeo` service with invalid signature or empty baggage, you will see the output which is supposed for valid requests. See `maffeo.git/README.md` for details.

#### AuthenticateOut

1. Run `goldstar-example-go-fx` locally following the instructions of [README.md](https://code.uberinternal.com/diffusion/ENGOLDP/browse/master/README.md).

2. Upload the DNS record for `wonkamaster-staging` following instructions above.

3. Look for the following log message printout in the terminal with the key word: `disabling wonka; may willie have mercy on our souls`, which means `Globel Disable` is enabled.

4. You may be able to see an error message with the words `Full enforcement client failed	{"error": "code:invalid-argument message:unable to get arg2 reader from inbound tchannel error ErrCodeBadRequest: unable to get arg2 reader from inbound tchannel error ErrCodeBadRequest: unauthenticated request: no wonka token in baggage"}`

  This is because `maffeo-staging` updates the DNS record later than `goldstar-example-go-fx` and rejects the latter's call. Otherwise, you may not see the error message.

5. In the next few minutes, you should be able to see the following log messages:
```
2017-12-15T18:03:25.763-0800	DEBUG	wonka-go.git/wonka_disabled.go:40	Refreshing global disabled status	{"galileo": {"entity": "goldstar-example-go-fx", "version": "galileo-go: 1.6.1-dev", "wonka": {"entity": "goldstar-example-go-fx", "version": "wonka-go: 1.5.0", "expired": "2017-12-15T18:03:15.762-0800", "now": "2017-12-15T18:03:25.763-0800"}}}
2017-12-15T18:03:25.763-0800	DEBUG	zap/global.go:89	authenticate out succeeded	{"galileo": {"entity": "goldstar-example-go-fx", "version": "galileo-go: 1.6.1-dev", "has_baggage": false, "destination": "maffeo-staging", "claim": "", "trace": {"span": "5b36afc2d9ba960f", "trace": "5b36afc2d9ba960f"}}}
2017-12-15T18:03:25.792-0800	DEBUG	wonka-go.git/wonka_disabled.go:111	wonka global disabled status refreshed	{"galileo": {"entity": "goldstar-example-go-fx", "version": "galileo-go: 1.6.1-dev", "wonka": {"entity": "goldstar-example-go-fx", "version": "wonka-go: 1.5.0"}}}
```

  That means the service is periodically updating Global Disable status.

6. After that, you should see the record is expired with the message of `disable message expired`.

#### Launch a Service when Global Disable is ON and Wonkamaster is not reachable
1. Launch the proxy for `maffeo-staging` only. In a terminal, run:
```
$  cerberus  -t maffeo-staging
```
2. In another terminal launch the service locally and see the error message:
```
returned a non-nil error: error initializing wonka for galileo: error getting cert signed: error getting cert signed by wonkamaster: Post http://127.0.0.1:16749/csr: dial tcp 127.0.0.1:16749: getsockopt: connection refused
make: *** [run] Error 1
```
3. Upload a new DNS record.

4. Wait for about 1 mintue, launch the service again. Look for the messages with the follow words:
  * `disabling wonka; may willie have mercy on our souls`
  * `wonka is currently disabled`
  * `error upgrading to certificate but ignoring due to global disabled`

  You may see an error message with the words
  ```
  Full enforcement client failed {"error": "code:invalid-argument message:unable to get arg2 reader from inbound tchannel error ErrCodeBadRequest: unable to get arg2 reader from inbound tchannel error ErrCodeBadRequest: unauthenticated request: no wonka token in baggage"}
  ```
  because `maffeo-staging` may not have updated Global Disable status. After that, you should see messages like:
```
2017-12-15T18:57:21.056-0800	INFO	goldstar-example-go-fx/main.go:133	Response	{"response": "goldstar-example-go-fx"}
```
That means `maffeo-staging` also updates the Global Disable status and bypasses `AuthenticateIn`. After a few minutes, you will see the above error message again.

### Test with Staging Services (Wonka/Galileo Development Only)

This section describes how to test panicking wonkamaster using two staging services (`wonkamaster-staging`, `maffeo-staging` and `goldstar-example-go-fx`). If you are not a Wonka/Galileo Developer, you may skip it.

#### AuthenticateIn
1. Start the proxies of `wonkamaster-staging` and `maffeo-staging`:
```
$ cerberus -s wonkamaster-staging -t maffeo-staging
```
2. Request a valid claim for `maffeo-staging`
```
$ WONKA_MASTER_HOST=127.0.0.1 WONKA_MASTER_PORT=16749 WONKA_MASTER_ECC_PUB=0222c15fa34947bbbd8bdcf30d1bb2ab340dbdca0fd1aa80e23df645480f6bae3 wonkacli request --name jianqingz@uber.com --to maffeo-staging -e 20h
```
You should get something like:
```
[14:45:46.01]  INFO requested claim obtained claim=EVERYONE,jianqingz@uber.com destination=maffeo-staging signature=EILxYEMfHgVG6I/OyBx/jTb3PouZ8QW4chmQttO0rzn/P8hNoEbulEb3rXxoYdHBAWMG9/itRIO6sr7QTFKjhg== validAfter=2017-12-01 14:44:45 -0800 PST validBefore=2017-12-02 10:45:45 -0800 PST validFor=20h1m0s
eyJjdCI6IldPTktBQyIsInZhIjoxNTEyMTY4Mjg1LCJ2YiI6MTUxMjI0MDM0NSwiZSI6ImppYW5xaW5nekB1YmVyLmNvbSIsImMiOlsiRVZFUllPTkUiLCJqaWFucWluZ3pAdWJlci5jb20iXSwiZCI6Im1hZmZlby1zdGFnaW5nIiwicyI6IkVJTHhZRU1mSGdWRzZJL095QngvalRiM1BvdVo4UVc0Y2htUXR0TzByem4vUDhoTm9FYnVsRWIzclh4b1lkSEJBV01HOS9pdFJJTzZzcjdRVEZLamhnPT0ifQ==
```
3. Test `maffeo-staging` with a valid request:
```
yab -B "x-wonka-auth:eyJjdCI6IldPTktBQyIsInZhIjoxNTEyMTY4Mjg1LCJ2YiI6MTUxMjI0MDM0NSwiZSI6ImppYW5xaW5nekB1YmVyLmNvbSIsImMiOlsiRVZFUllPTkUiLCJqaWFucWluZ3pAdWJlci5jb20iXSwiZCI6Im1hZmZlby1zdGFnaW5nIiwicyI6IkVJTHhZRU1mSGdWRzZJL095QngvalRiM1BvdVo4UVc0Y2htUXR0TzByem4vUDhoTm9FYnVsRWIzclh4b1lkSEJBV01HOS9pdFJJTzZzcjdRVEZLamhnPT0ifQ==" --jaeger -t idl/code.uber.internal/engsec/maffeo/maffeo.thrift -p 127.0.0.1:21300 maffeo-staging FullEnforce::hello
```
You should get something like:
```
{
  "body": {
    "result": "yab-jianqingz"
  },
  "ok": true,
  "trace": "28fcfc27e390284"
}
```
4. Generate a new DNS TXT record following instructions above using `wonkamaster-staging` private key.
5. Update DNS TXT record with the host value of `KMKPB8EQ5JVJDD778OD3R59Q7FP17QKED6H1QD025B0KKMI3PGDG.uberinternal.com`
6. Wait for about 1 minute, test `maffeo-staging` with an invalid request. If the first try still cannot go through, try it again. It should succeed for the second time.
7. Wait till the record expires and test with invalid requests again. It should be rejected.

#### AuthenticateOut

##### Test with mistakenly configured consuming service
1. On uDeploy, deploy `goldstar-example-go-fx` with commit `eab9aae63ce7` or `v0.0.1-7-geab9aae` for `staging`. This commit will have `goldstar-example-go-fx` request a wonka certificate from `wonkamaster prod` but request wonka claims from `wonkamaster-staging`. Such incorrect configuration will cause `AuthenticateOut` failure and call to `maffeo-staging` fail as well.
2. Check the `Standard Output` of `goldstar-example-go-fx-staging` on uDeploy. You should see the messages:
```
...
2017-12-21 05:39:14Z	Network server done warming up.
2017-12-21 05:39:14Z	Started call cycle
2017-12-21 05:39:24Z	authenticate out failed
2017-12-21 05:39:24Z	Full enforcement client failed
...
```
3. Update DNS TXT record for `wonkamaster-staging` and enable Global Disable.
4. Wait for about 1 minute and expect the following messages on uDeploy:
```
...
2017-12-21 05:48:04Z	Response
2017-12-21 05:48:14Z	disabling wonka; may willie have mercy on our souls
2017-12-21 05:48:14Z	Response
...
```
`Response` means `goldstar-example-go-fx-staging` successfully receives responses from `maffeo-staging`.
5. Wait until the record expires and check the following messages:
```
...
2017-12-21 05:50:34Z	Response
2017-12-21 05:50:34Z	re-enabling wonka
2017-12-21 05:50:44Z	Response
...
2017-12-21 05:51:34Z	Recovered from global disable state
2017-12-21 05:51:44Z	Full enforcement client failed
...
```
That is, `wonkamaster-staging` recovers from panic

#### Test with staging services
1. Check the log of a properly configured `goldstar-example-go-fx` service in `staging` on uDeploy (`Process Manager` -> `Standard Output`).
2. Update DNS TXT record for `webmaster-staging`.
3. Wait for about a minute and check for the message:
```
2017-12-22 06:06:20Z disabling wonka; may willie have mercy on our souls
```
4. Wait until the record expires and check for the messages like:
```
...
2017-12-22 06:07:30Z re-enabling wonka
...
2017-12-22 06:08:30Z Recovered from global disable state
...
```

#### Restart staging services when Global Disable is enabled
1. Update DNS TXT record for `webmaster-staging`.
2. On uDeploy, check the logs for `goldstar-example-go-fx` and `maffeo` services in `staging`.
3. Wait for about a minute and check for the message like:
```
disabling wonka; may willie have mercy on our souls
```
4. Open a web browser and visit https://grafana4.uberinternal.com/dashboard/db/galileo-service-owners
5. In `Service Name` choose `maffeo-staging`
6. In `Requests` section check `Requests received by entity maffeo-staging (AuthenticateIn)`, you should see a signficant drop.
7. In `Service Name` choose `goldstart-example-go-fx-staging`
8. In `Requests` section check `Services receiving requests from goldstar-example-go-fx-staging`, you should also see a signficant drop.
9. On uDeploy, restart `goldstart-example-go-fx-staging`.
10. Check the log and you should see messages like:
```
disabling wonka; may willie have mercy on our souls
...
wonka is currently disabled
```
11. Wait until the DNS record expired and check the log again. You should see the message like:
```
Recovered from global disable state
```
12. Check `grafana` for `goldstart-example-go-fx-staging` and confirm the line for the requests number recovers too.
13. Repeat Step 9 to Step 12 for `maffeo-staging`.

## Wonkacli In Panic

TBD

## Other Issues

### Panic Status Refresh Frequency
Galileo refreshes panic status every minute. For some corner cases, a request just comes when a cached record stales and Galileo need checks the record. To garauntee quick response, the logic here is to respond the request immediately with the old status and refresh status (check the DNS record remotely). In this case, the failed request will trigger the refresh and make sure the subsequent requests are responed appropriately. The wonka client should request again. This also applies for "return from panic".

### Return From Panic Manually

In addition to DNS record expiration, we can have Wonka/Galileo return from panic manualy. The approach is simple: put a placehold text less than 60 chars as the content of record. Galileo will ignore the record and return from panic.
